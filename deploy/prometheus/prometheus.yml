# Prometheus configuration for tokio_php
#
# Usage:
#   docker compose --profile monitoring up -d
#   Open http://localhost:9091 for Prometheus UI
#   Open http://localhost:3000 for Grafana (admin/admin)

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    monitor: 'tokio_php'

# Alertmanager configuration (optional)
# alerting:
#   alertmanagers:
#     - static_configs:
#         - targets:
#           - alertmanager:9093

# Load alerting rules
rule_files:
  - /etc/prometheus/alerts.yml

scrape_configs:
  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # tokio_php internal server
  - job_name: 'tokio_php'
    static_configs:
      - targets: ['tokio_php:9090']
    scrape_interval: 5s
    metrics_path: /metrics
    # Relabel to add instance label
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: '([^:]+):\d+'
        replacement: '${1}'

  # tokio_php TLS variant (when using --profile tls,monitoring)
  - job_name: 'tokio_php_tls'
    static_configs:
      - targets: ['tokio_php_tls:9090']
    scrape_interval: 5s
    metrics_path: /metrics
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: '([^:]+):\d+'
        replacement: '${1}'
