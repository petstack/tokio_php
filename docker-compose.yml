services:
  tokio_php:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # PHP version: 8.4 or 8.5
        PHP_VERSION: ${PHP_VERSION:-8.5}
        # Cargo features: tokio-sapi (default), grpc, otel, debug-profile
        # tokio-sapi = pure Rust SAPI (no C extension needed)
        # Examples:
        #   CARGO_FEATURES="tokio-sapi" docker compose build             # SAPI only
        #   CARGO_FEATURES="tokio-sapi,grpc" docker compose build        # + gRPC
        #   CARGO_FEATURES="tokio-sapi,grpc,otel" docker compose build   # + gRPC + OpenTelemetry
        CARGO_FEATURES: ${CARGO_FEATURES:-tokio-sapi,grpc,otel}
    ports:
      - "8080:8080"
      - "9090:9090"
      # gRPC port (requires CARGO_FEATURES=grpc build)
      - "50051:50051"
    environment:
      - LISTEN_ADDR=0.0.0.0:8080
      - RUST_LOG=tokio_php=info
      # PHP_WORKERS: number of PHP worker processes (0 = auto-detect from CPU cores)
      - PHP_WORKERS=${PHP_WORKERS:-0}
      # EXECUTOR: script executor mode
      #   sapi - pure Rust SAPI (default for tokio-sapi builds, recommended)
      #   ext  - C extension mode (legacy, requires build without tokio-sapi)
      #   php  - legacy mode with zend_eval_string (requires build without tokio-sapi)
      #   stub - benchmark mode, returns empty responses without PHP execution
      - EXECUTOR=${EXECUTOR:-sapi}
      # QUEUE_CAPACITY: max pending requests in queue (0 = workers * 100)
      - QUEUE_CAPACITY=${QUEUE_CAPACITY:-0}
      # INDEX_FILE: single entry point mode (e.g., index.php)
      - INDEX_FILE=${INDEX_FILE:-}
      # DOCUMENT_ROOT: web root directory (default: /var/www/html)
      - DOCUMENT_ROOT=${DOCUMENT_ROOT:-/var/www/html}
      # INTERNAL_ADDR: internal server for /health and /metrics
      - INTERNAL_ADDR=0.0.0.0:9090
      # ERROR_PAGES_DIR: directory with custom HTML error pages (e.g., 404.html, 500.html)
      - ERROR_PAGES_DIR=${ERROR_PAGES_DIR:-/var/www/html/errors}
      # ACCESS_LOG: set to 1 or true to enable access logs
      - ACCESS_LOG=${ACCESS_LOG:-0}
      # RATE_LIMIT: max requests per IP per window (0 = disabled)
      - RATE_LIMIT=${RATE_LIMIT:-0}
      # RATE_WINDOW: rate limit window in seconds (default: 60)
      - RATE_WINDOW=${RATE_WINDOW:-60}
      # STATIC_CACHE_TTL: cache duration for static files (1d, 1w, 1m, 1y, off)
      - STATIC_CACHE_TTL=${STATIC_CACHE_TTL:-1d}
      # REQUEST_TIMEOUT: request timeout (30s, 2m, 5m, off). Returns 504 on timeout
      - REQUEST_TIMEOUT=${REQUEST_TIMEOUT:-2m}
      # OpenTelemetry (requires CARGO_FEATURES=otel build)
      - OTEL_ENABLED=${OTEL_ENABLED:-0}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://jaeger:4317}
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME:-tokio_php}
      - OTEL_ENVIRONMENT=${OTEL_ENVIRONMENT:-development}
      - OTEL_SAMPLING_RATIO=${OTEL_SAMPLING_RATIO:-1.0}
      # GRPC_ADDR: gRPC server address (requires --features grpc build)
      # Example: GRPC_ADDR=0.0.0.0:50051
      - GRPC_ADDR=${GRPC_ADDR:-}
      # GRPC_TLS: gRPC TLS mode (off, auto, on)
      #   off  - plaintext (default, development)
      #   auto - auto-generated self-signed certificates (development)
      #   on   - external certificates (production)
      - GRPC_TLS=${GRPC_TLS:-off}
      # GRPC_TLS_CERT/KEY: external certificate paths (required when GRPC_TLS=on)
      - GRPC_TLS_CERT=${GRPC_TLS_CERT:-}
      - GRPC_TLS_KEY=${GRPC_TLS_KEY:-}
      # GRPC_TLS_CA: CA certificate for mTLS (optional, enables client cert verification)
      - GRPC_TLS_CA=${GRPC_TLS_CA:-}
    volumes:
      - ./www:/var/www/html:ro
      # PHP configuration (OPcache, JIT, etc.)
      - ./php.ini:/usr/local/etc/php/conf.d/tokio_php.ini:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9090/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
#    logging:
#      driver: "none"  # или ограничить: driver: "json-file", options: { max-size: "1m" }

  # HTTPS/TLS variant (uses Docker secrets for certificates)
  tokio_php_tls:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PHP_VERSION: ${PHP_VERSION:-8.5}
        CARGO_FEATURES: ${CARGO_FEATURES:-tokio-sapi,grpc,otel}
    ports:
      - "8443:8443"
      - "9090:9090"
    environment:
      - LISTEN_ADDR=0.0.0.0:8443
      - RUST_LOG=tokio_php=info
      - PHP_WORKERS=${PHP_WORKERS:-0}
      - EXECUTOR=${EXECUTOR:-sapi}
      - INDEX_FILE=${INDEX_FILE:-}
      - DOCUMENT_ROOT=${DOCUMENT_ROOT:-/var/www/html}
      - TLS_CERT=/run/secrets/tls_cert
      - TLS_KEY=/run/secrets/tls_key
      - INTERNAL_ADDR=0.0.0.0:9090
      - ERROR_PAGES_DIR=${ERROR_PAGES_DIR:-/var/www/html/errors}
      - ACCESS_LOG=${ACCESS_LOG:-0}
      - RATE_LIMIT=${RATE_LIMIT:-0}
      - RATE_WINDOW=${RATE_WINDOW:-60}
      - STATIC_CACHE_TTL=${STATIC_CACHE_TTL:-1d}
      - REQUEST_TIMEOUT=${REQUEST_TIMEOUT:-2m}
      # OpenTelemetry (requires CARGO_FEATURES=otel build)
      - OTEL_ENABLED=${OTEL_ENABLED:-0}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://jaeger:4317}
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME:-tokio_php}
      - OTEL_ENVIRONMENT=${OTEL_ENVIRONMENT:-development}
      - OTEL_SAMPLING_RATIO=${OTEL_SAMPLING_RATIO:-1.0}
      - GRPC_ADDR=${GRPC_ADDR:-}
    secrets:
      - tls_cert
      - tls_key
    volumes:
      - ./www:/var/www/html:ro
      - ./php.ini:/usr/local/etc/php/conf.d/tokio_php.ini:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9090/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    profiles:
      - tls

  # Prometheus for metrics collection
  prometheus:
    image: prom/prometheus:v2.51.0
    ports:
      - "9091:9090"
    volumes:
      - ./deploy/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./deploy/prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    restart: unless-stopped
    depends_on:
      - tokio_php
    profiles:
      - monitoring

  # Grafana for dashboards
  grafana:
    image: grafana/grafana:10.4.0
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=${GRAFANA_ROOT_URL:-http://localhost:3000}
    volumes:
      - ./deploy/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./deploy/grafana/tokio-php-dashboard.json:/var/lib/grafana/dashboards/tokio-php-dashboard.json:ro
      - grafana_data:/var/lib/grafana
    restart: unless-stopped
    depends_on:
      - prometheus
    profiles:
      - monitoring

  # Jaeger for distributed tracing (OpenTelemetry)
  jaeger:
    image: jaegertracing/all-in-one:1.54
    ports:
      - "16686:16686"   # Jaeger UI
      - "4317:4317"     # OTLP gRPC
      - "4318:4318"     # OTLP HTTP
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - LOG_LEVEL=info
    restart: unless-stopped
    profiles:
      - monitoring
      - tracing

volumes:
  prometheus_data:
  grafana_data:

secrets:
  tls_cert:
    file: ${TLS_CERT_FILE:-./certs/cert.pem}
  tls_key:
    file: ${TLS_KEY_FILE:-./certs/key.pem}
