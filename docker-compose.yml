services:
#  tokio_php_embed:
#    build:
#      context: .
#      dockerfile: Dockerfile
#    ports:
#      - "8080:8080"
#      - "9090:9090"
#    environment:
#      - LISTEN_ADDR=0.0.0.0:8080
#      - RUST_LOG=tokio_php=info
#      # PHP_WORKERS: number of PHP worker processes (0 = auto-detect from CPU cores)
#      - PHP_WORKERS=${PHP_WORKERS:-0}
#      # USE_STUB: set to 1 or true to disable PHP and return empty responses
#      - USE_STUB=${USE_STUB:-0}
#      # PROFILE: set to 1 or true to enable profiling (requires X-Profile: 1 header)
#      - PROFILE=${PROFILE:-1}
#      # USE_SAPI: set to 1 or true to use custom SAPI executor
#      - USE_SAPI=${USE_SAPI:-0}
#      # INDEX_FILE: single entry point mode (e.g., index.php)
#      - INDEX_FILE=${INDEX_FILE:-}
#      # DOCUMENT_ROOT: web root directory (default: /var/www/html)
#      - DOCUMENT_ROOT=${DOCUMENT_ROOT:-/var/www/html}
#      # INTERNAL_ADDR: internal server for /health and /metrics
#      - INTERNAL_ADDR=0.0.0.0:9090
#    volumes:
#      - ./www:/var/www/html:ro
#    restart: unless-stopped
#
  tokio_php_sapi:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8081:8080"
      - "9091:9090"
    environment:
      - LISTEN_ADDR=0.0.0.0:8080
      - RUST_LOG=tokio_php=info
      # PHP_WORKERS: number of PHP worker processes (0 = auto-detect from CPU cores)
      - PHP_WORKERS=${PHP_WORKERS:-0}
      # USE_STUB: set to 1 or true to disable PHP and return empty responses
      - USE_STUB=${USE_STUB:-0}
      # PROFILE: set to 1 or true to enable profiling (requires X-Profile: 1 header)
      - PROFILE=${PROFILE:-1}
      # USE_SAPI: set to 1 or true to use custom SAPI executor
      - USE_SAPI=${USE_SAPI:-1}
      # INDEX_FILE: single entry point mode (e.g., index.php)
      - INDEX_FILE=${INDEX_FILE:-}
      # DOCUMENT_ROOT: web root directory (default: /var/www/html)
      - DOCUMENT_ROOT=${DOCUMENT_ROOT:-/var/www/html}
      # INTERNAL_ADDR: internal server for /health and /metrics
      - INTERNAL_ADDR=0.0.0.0:9090
    volumes:
      - ./www:/var/www/html:ro
    restart: unless-stopped

  # HTTPS/TLS variants
  tokio_php_embed_tls:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8443:8443"
    environment:
      - LISTEN_ADDR=0.0.0.0:8443
      - RUST_LOG=tokio_php=info
      - PHP_WORKERS=${PHP_WORKERS:-0}
      - USE_STUB=${USE_STUB:-0}
      - PROFILE=${PROFILE:-1}
      - USE_SAPI=${USE_SAPI:-0}
      - INDEX_FILE=${INDEX_FILE:-}
      - DOCUMENT_ROOT=${DOCUMENT_ROOT:-/var/www/html}
      - TLS_CERT=/certs/cert.pem
      - TLS_KEY=/certs/key.pem
    volumes:
      - ./www:/var/www/html:ro
      - ./certs:/certs:ro
    restart: unless-stopped
    profiles:
      - tls

  tokio_php_sapi_tls:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8444:8443"
    environment:
      - LISTEN_ADDR=0.0.0.0:8443
      - RUST_LOG=tokio_php=info
      - PHP_WORKERS=${PHP_WORKERS:-0}
      - USE_STUB=${USE_STUB:-0}
      - PROFILE=${PROFILE:-1}
      - USE_SAPI=${USE_SAPI:-1}
      - INDEX_FILE=${INDEX_FILE:-}
      - DOCUMENT_ROOT=${DOCUMENT_ROOT:-/var/www/html}
      - TLS_CERT=/certs/cert.pem
      - TLS_KEY=/certs/key.pem
    volumes:
      - ./www:/var/www/html:ro
      - ./certs:/certs:ro
    restart: unless-stopped
    profiles:
      - tls
