services:
  tokio_php:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # PHP version: 8.4 or 8.5
        PHP_VERSION: ${PHP_VERSION:-8.5}
        # Cargo features (e.g., "debug-profile" for profiling build)
        CARGO_FEATURES: ${CARGO_FEATURES:-}
    ports:
      - "8080:8080"
      - "9090:9090"
    environment:
      - LISTEN_ADDR=0.0.0.0:8080
      - LOG_LEVEL=${LOG_LEVEL:-trace}
      # PHP_WORKERS: number of PHP worker processes (0 = auto-detect from CPU cores)
      - PHP_WORKERS=${PHP_WORKERS:-0}
      # EXECUTOR: script executor mode (ext, php, stub)
      #   ext - recommended for production, uses php_execute_script() with FFI superglobals
      #   php - legacy mode, uses zend_eval_string()
      #   stub - benchmark mode, returns empty responses without PHP execution
      - EXECUTOR=${EXECUTOR:-ext}
      # QUEUE_CAPACITY: max pending requests in queue (0 = workers * 100)
      - QUEUE_CAPACITY=${QUEUE_CAPACITY:-0}
      # INDEX_FILE: single entry point mode (e.g., index.php)
      - INDEX_FILE=${INDEX_FILE:-}
      # DOCUMENT_ROOT: web root directory (default: /var/www/html)
      - DOCUMENT_ROOT=${DOCUMENT_ROOT:-/var/www/html}
      # INTERNAL_ADDR: internal server for /health and /metrics
      - INTERNAL_ADDR=0.0.0.0:9090
      # ERROR_PAGES_DIR: directory with custom HTML error pages (e.g., 404.html, 500.html)
      - ERROR_PAGES_DIR=${ERROR_PAGES_DIR:-/var/www/html/errors}
      # ACCESS_LOG: set to 1 or true to enable access logs
      - ACCESS_LOG=${ACCESS_LOG:-1}
      # RATE_LIMIT: max requests per IP per window (0 = disabled)
      - RATE_LIMIT=${RATE_LIMIT:-0}
      # RATE_WINDOW: rate limit window in seconds (default: 60)
      - RATE_WINDOW=${RATE_WINDOW:-60}
      # STATIC_CACHE_TTL: cache duration for static files (1d, 1w, 1m, 1y, off)
      - STATIC_CACHE_TTL=${STATIC_CACHE_TTL:-1d}
      # REQUEST_TIMEOUT: request timeout (30s, 2m, 5m, off). Returns 504 on timeout
      - REQUEST_TIMEOUT=${REQUEST_TIMEOUT:-2m}
      # SSE_TIMEOUT: SSE/streaming connection timeout (30m, 1h, off)
      - SSE_TIMEOUT=${SSE_TIMEOUT:-30m}
      # DRAIN_TIMEOUT_SECS: graceful shutdown drain timeout in seconds
      - DRAIN_TIMEOUT_SECS=${DRAIN_TIMEOUT_SECS:-30}
      # HEADER_TIMEOUT_SECS: header read timeout (Slowloris protection)
      - HEADER_TIMEOUT_SECS=${HEADER_TIMEOUT_SECS:-5}
      # IDLE_TIMEOUT_SECS: idle connection timeout (keep-alive)
      - IDLE_TIMEOUT_SECS=${IDLE_TIMEOUT_SECS:-60}
    volumes:
      - ./www:/var/www/html:ro
      # PHP configuration (OPcache, JIT, etc.)
      - ./php.ini:/usr/local/etc/php/conf.d/tokio_php.ini:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9090/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # HTTPS/TLS variant (uses Docker secrets for certificates)
  tokio_php_tls:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PHP_VERSION: ${PHP_VERSION:-8.5}
        CARGO_FEATURES: ${CARGO_FEATURES:-}
    ports:
      - "8443:8443"
      - "9090:9090"
    environment:
      - LISTEN_ADDR=0.0.0.0:8443
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - PHP_WORKERS=${PHP_WORKERS:-0}
      - EXECUTOR=${EXECUTOR:-ext}
      - INDEX_FILE=${INDEX_FILE:-}
      - DOCUMENT_ROOT=${DOCUMENT_ROOT:-/var/www/html}
      - TLS_CERT=/run/secrets/tls_cert
      - TLS_KEY=/run/secrets/tls_key
      - INTERNAL_ADDR=0.0.0.0:9090
      - ERROR_PAGES_DIR=${ERROR_PAGES_DIR:-/var/www/html/errors}
      - ACCESS_LOG=${ACCESS_LOG:-0}
      - RATE_LIMIT=${RATE_LIMIT:-0}
      - RATE_WINDOW=${RATE_WINDOW:-60}
      - STATIC_CACHE_TTL=${STATIC_CACHE_TTL:-1d}
      - REQUEST_TIMEOUT=${REQUEST_TIMEOUT:-2m}
      - SSE_TIMEOUT=${SSE_TIMEOUT:-30m}
      - DRAIN_TIMEOUT_SECS=${DRAIN_TIMEOUT_SECS:-30}
      - HEADER_TIMEOUT_SECS=${HEADER_TIMEOUT_SECS:-5}
      - IDLE_TIMEOUT_SECS=${IDLE_TIMEOUT_SECS:-60}
    secrets:
      - tls_cert
      - tls_key
    volumes:
      - ./www:/var/www/html:ro
      - ./php.ini:/usr/local/etc/php/conf.d/tokio_php.ini:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9090/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    profiles:
      - tls

secrets:
  tls_cert:
    file: ${TLS_CERT_FILE:-./certs/cert.pem}
  tls_key:
    file: ${TLS_KEY_FILE:-./certs/key.pem}
