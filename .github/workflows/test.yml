name: Tests

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Run integration tests with Docker
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker compose build

      - name: Start server
        run: |
          docker compose up -d
          sleep 10  # Wait for server to be ready

      - name: Check server health
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost:9091/health; then
              echo ""
              echo "Server is healthy"
              break
            fi
            echo "Waiting for server... ($i/30)"
            sleep 2
          done

      - name: Run integration tests
        run: ./scripts/run-integration-tests.sh
        env:
          TEST_SERVER_URL: http://localhost:8081
          TEST_INTERNAL_URL: http://localhost:9091

      - name: Show server logs on failure
        if: failure()
        run: docker compose logs

      - name: Stop server
        if: always()
        run: docker compose down -v

  # Benchmark comparison (optional, only on main branch)
  benchmark:
    name: Benchmark
    runs-on: ubuntu-latest
    needs: integration-tests
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker compose build

      - name: Start server
        run: |
          docker compose up -d
          sleep 15  # Wait for server and OPcache warmup

      - name: Install wrk
        run: |
          sudo apt-get update
          sudo apt-get install -y wrk

      - name: Warmup
        run: |
          for i in {1..100}; do
            curl -s http://localhost:8081/bench.php > /dev/null
          done

      - name: Run benchmark
        run: |
          echo "## Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### bench.php (minimal PHP)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          wrk -t4 -c100 -d10s http://localhost:8081/bench.php | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### index.php (full page)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          wrk -t4 -c100 -d10s http://localhost:8081/index.php | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Stop server
        if: always()
        run: docker compose down -v
